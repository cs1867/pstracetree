<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15">
    <title>Traceroute chart</title>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="sorttable.js"></script>

    <style>
    /* Sortable tables */
table.sortable thead {
   background-color:#eee;
   color:#666666;
   font-weight: bold;
   cursor: default;
   } 
</style>

<script>


function fetch_ls(ls){
    ma_list=[];
    var url='cors.pl?method=GET&url=' + ls;
    //$.getJSON( url, function( loc){
    $.getJSON( encodeURI(url), function( loc){
	$.each(loc.hosts, function(index, host){
	    fetch_ma(host.locator);
	} );
    } )
    .fail(function( jqxhr, textStatus, error) {
	msg= "Failed to get "+ ls + " error " + textStatus + ", " + error;
	console.log(msg);
	// alert(msg);
	// fuck CORS :
	fetch_ma('http://35.237.255.214:8090/lookup/records');
    } ); 
}

function fetch_ma(loc){
    var url= 'cors.pl?method=GET&url=' + loc + '&type=service&service-type=ma' ;
    var re=/\d[\d\.:]+\d/;  // extract address
 
    //var head='<font style="font-weight:bold; font-size:large;">Measurement archives</font> ';
    var head='<input type="text" id="ma_in" onkeyup="search_table_ma()" placeholder="Search table..">';
    head+='<table id="ma_table" class=sortable border=1><thead title="Sortable"><tr><th>Service<th>Location<th>Country<th>URls</thead><tbody>';
    var tail='</tbody></table>';

    // $.getJSON( encodeURI(url), function( mas){
    $.getJSON( url, function( mas){
	var rows=[];
	$.each(mas, function(index, ma){
	    if ( ma["psservice-eventtypes"].indexOf( "packet-trace") >= 0 ){
		// console.log (ma["location-sitename"] + ' - ' + ma["service-locator"][0]);
		var tr = '<tr><td>'+ ma["service-name"] + '<td>' + ma["location-sitename"] + '<td>' + ma["location-country"];
		var first=true;
		$.each( ma["service-locator"], function( index, base ){
		    if ( first){
			tr+='<td>';
			first=false;
		    }
			
		    var srv = base.split("/").slice(0,3).join("/");
	    	    // tr += '<td><a href="ls.html?ma=' + base + '">' + srv  + '</a>' ;
		    tr += '<button onclick=fetch_base("' + base + '")> ' + srv  + '</button> ' ;
		} );
		//$('#ma_table tr:last').after( tr);
		head+=tr;
	    }
	} );
	$("#ma").html( head+tail)
	    .ready( function(){
		sorttable.makeSortable(document.getElementById("ma_table"))
	    });

	//makeSortable(document.getElementById("ma_table"));
    } )
    .fail(function( jqxhr, textStatus, error) {
	msg= "Failed to get "+ url + " error " + textStatus + ", " + error;
	$("#ma").innerHTML='<h3>' + msg + '</h3>';
	console.log(msg);
	alert(msg);
    });
}

var measurements=[]; // measurement
var pairs={}; // list of unique peers
var tr_events=[]; // list of events
var urlParams = {};

function fetch_base(url){
    $('#tabs').tabs({'active': 1});

    var server= url.split("/").slice(0,3).join("/");
    if ( url.slice(-1) !== "/" ){
	url += "/";	
    }
    
    url+='&tool-name=pscheduler/traceroute';
    url = 'cors.pl?method=GET&url=' + url;
    var msg='Fetching MA ' + url;
    console.log(msg);
    $("#peers").html(msg);
    var head='<input type="text" id="peer_in" onkeyup="search_table_peer()" placeholder="Search table..">';
    head+='<table  id="peer_table" class=sortable border=0><thead title="Sortable"><tr><th>Peers list</thead><tbody>';
    var tail='</tbody></table>';

    $.getJSON( url, function( events){
	$.each(events, function(index, event){
	    if ( event["pscheduler-test-type"] === "trace" ){
		$.each( event["event-types"], function(index, evt){
		    if ( evt["event-type"] === "packet-trace" ){
			measurements.push(evt);
			var mno = measurements.length - 1;
			tr_events.push( event);
			var pair =  event["input-source"] + ' - ' + event["input-destination"];
			if ( ! pairs[pair] ){ // avoid duplicates
			    //var tr = '<tr><td><a href=ls.html?pair=' + mno + '>' + pair + '</a>';
			    var tr = '<tr><td><button onclick=\'tracetree("' + server + '", ' + mno + ')\'>' + pair + '</button>';
			    head+=tr;
			    //$('#peer_table tr:last').after( tr);
			    pairs[pair] = true;
			}
		    }
		});
	    }
	} );
	$("#peers").html( head + tail)
	    .ready( function(){
		sorttable.makeSortable(document.getElementById("peer_table"))
	    });
	//makeSortable( document.getElementById("peer_table"));
    } )
	.fail(function( jqxhr, textStatus, error) {
	    msg= "Failed to get "+ url + " error " + textStatus + ", " + error;
	    console.log(msg);
	    alert(msg);
    });   
    // pscheduler-test-type
}

function tracetree( srv, mno){
    //var srv=urlParams['ma'].split("/").slice(0,3).join("/");
      
    var base =  srv + measurements[ mno ]['base-uri'];
    var url='tracetree.html?mahost=' + base;
    url+="&from=" + tr_events[mno]["input-source"];
    url+="&to=" + tr_events[mno]["input-destination"];
    //window.open( url, '_blank') ;
    $('#trace').html(
	'<iframe id="itrace" width=100% height=1000 src="about:blank" frameborder="0" scrolling="yes"></iframe>');
    document.getElementById('itrace').src = url;
    $('#tabs').tabs({'active': 2});

    
}

$(document).ready( function(){
    $(function(){
	$( "#tabs" ).tabs();
    } );
    // (window.onpopstate = function () {
	var match,
            pl     = /\+/g,  // Regex for replacing addition symbol with a space
            search = /([^&=]+)=?([^&]*)/g,
            decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
            query  = window.location.search.substring(1);
	    var from,
		to;

	var parm='';

	while (match = search.exec(query))
	    urlParams[decode(match[1])] = decode(match[2]);
	
    	if ( urlParams['mahost']){
	    fetch_base( urlParams['mahost'] );
	} else {
	    fetch_ls('http://ps-west.es.net/lookup/activehosts.json')
	}
    // } );

} );

/* function sortTable(table, col, reverse) {
    var tb = table.tBodies[0], // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
        tr = Array.prototype.slice.call(tb.rows, 0), // put rows into array
        i;
    reverse = -((+reverse) || -1);
    tr = tr.sort(function (a, b) { // sort rows
        return reverse // `-1 *` if want opposite order
            * (a.cells[col].textContent.trim() // using `.textContent.trim()` for test
                .localeCompare(b.cells[col].textContent.trim())
               );
    });
    for(i = 0; i < tr.length; ++i) tb.appendChild(tr[i]); // append each row in order
}

function makeSortable(table) {
    var th = table.tHead, i;
    th && (th = th.rows[0]) && (th = th.cells);
    if (th) i = th.length;
    else return; // if no `<thead>` then do nothing
    while (--i >= 0) (function (i) {
        var dir = 1;
        th[i].addEventListener('click', function () {sortTable(table, i, (dir = 1 - dir))});
    }(i));
}

function makeAllSortable(parent) {
    parent = parent || document.body;
    var t = parent.getElementsByTagName('table'), i = t.length;
    while (--i >= 0) makeSortable(t[i]);
}

		      */

function search_table_ma() {
    search_table('ma_in', 'ma_table');
}
function search_table_peer() {
    search_table('peer_in', 'peer_table');
}

function search_table(input,table) {
    // Declare variables
    var input, filter, table, tr, td, i;
    input = document.getElementById(input);
    filter = input.value.toUpperCase();
    table = document.getElementById(table);
    tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
	//td = tr[i].getElementsByTagName("td")[0];
	var hit=false;
	$.each(tr[i].getElementsByTagName("td"), function( index, td ){
	    if (td) {
		if ( td.innerHTML.toUpperCase().indexOf(filter) > -1) {
		    hit=true;
		}
	    } else {
		hit=true;
	    }
	} );
	if ( hit === true){
            tr[i].style.display = "";
	} else {
            tr[i].style.display = "none";
	}
    }
}
</script>		      

</script>

</head>
<body>
  <h2>World Perfsonar Measurement Archives</h2>
  <div id=tabs>
  
    <ul>
      <li><a id=tab-ma href="#ma">Measurement Archives</a>
      <li><a id=tab-peers href="#peers">Peers</a>
      <li><a id=tab-trace href="#trace">Traceroute</a>
    </ul>
    <div id=ma><h2 style=text-align:center> Please wait for MA list!</div>
    <div id=peers>
      <h2 style=text-align:center> Please select measurement archive!</h2>
    </div>
    <div id=trace>
      <h2 style=text-align:center>Please choose peers</h2>
    </div>
  </div>
</body></html>

